# DrowsyDetect 集成测试用例说明书

## 1. 文档目的
验证 DrowsyDetect 在真实浏览器环境中的端到端集成链路正确性与稳定性，覆盖摄像头获取 → 视频渲染 → FaceMesh 推理 → EAR 计算 → 疲劳预警 → UI 呈现的完整流程，以及错误回退与参数联动行为。

## 2. 测试范围
- 摄像头链路：设备枚举、权限、启停、设备切换、回退到 getUserMedia
- 模型链路：MediaPipe 资源加载、初始化、推理回调、重试
- 计算链路：关键点获取、EAR 计算、连续帧计数、阈值判断
- UI 联动：控制面板、指标显示(FPS/EAR/状态/检测/模型)、预警展示、叠加开关
- 参数联动：置信阈值、EAR 阈值、持续帧数对检测结果与 UI 的影响

## 3. 测试环境
- 浏览器：Chrome 88+ / Edge 88+ / Firefox 85+ / Safari 14+
- 操作系统：Windows 10/11、macOS、Linux 任一
- 访问方式：`http://localhost:8000` 或 `https://` 安全上下文
- 设备：内置或外接摄像头 ≥1 个；可选多摄像头
- 网络：可访问 jsDelivr (MediaPipe CDN)

## 4. 术语与前置条件
- 术语：EAR(眼睛纵横比)，Consec(连续闭眼帧数)
- 前置：页面成功加载，控制台无致命错误；允许浏览器访问摄像头

## 5. 用例矩阵总览
- 摄像头链路（CAM）
  - CAM-001 启动/停止摄像头
  - CAM-002 设备枚举并填充下拉框
  - CAM-003 切换指定摄像头
  - CAM-004 非安全上下文提示与回退
  - CAM-005 CameraUtils 不可用时回退 getUserMedia
- 模型链路（MOD）
  - MOD-001 模型正常加载并变更“模型: 已加载”
  - MOD-002 模型加载失败显示重试按钮并可重试成功
  - MOD-003 模型加载后 onResults 回调触发
- 计算链路（ALG）
  - ALG-001 无人脸时状态与计数清零，无预警
  - ALG-002 检测到人脸并显示 EAR、检测状态
  - ALG-003 EAR 低于阈值连续 N 帧触发预警
  - ALG-004 EAR 高于阈值时清零预警
- 参数联动（CFG）
  - CFG-001 调节置信阈值影响 FaceMesh 选项并实时显示
  - CFG-002 调节 EAR 阈值影响告警灵敏度
  - CFG-003 调节持续帧数影响告警触发时机
  - CFG-004 叠加开关影响关键点渲染
- UI 指标（UI）
  - UI-001 FPS 数值随帧处理更新
  - UI-002 状态/检测/模型标签按流程更新
  - UI-003 预警条按条件显隐

## 6. 详细测试用例

### CAM-001 启动/停止摄像头
- 前置：页面加载完成
- 步骤：
  1) 点击“启动摄像头”
  2) 授权摄像头权限
  3) 观察 `<video>` 显示实时画面
  4) 点击“停止摄像头”
- 期望：
  - 成功获取权限后 `状态: 已获取摄像头，加载模型中…/运行中(回退模式)`
  - `<video>` 播放流成功；停止后视频流中断，按钮状态切换

### CAM-002 设备枚举并填充下拉框
- 步骤：等待页面自动调用设备枚举
- 期望：
  - `摄像头` 下拉列表追加实际设备项（label 或“摄像头 n”）
  - 控制台输出“找到 X 个摄像头设备”

### CAM-003 切换指定摄像头
- 前置：至少两枚摄像头
- 步骤：
  1) 启动摄像头
  2) 在下拉中选择另一设备
  3) 停止并再次启动
- 期望：
  - 重新拉起后使用新 `deviceId`，视频画面来源切换

### CAM-004 非安全上下文提示与回退
- 步骤：以 `file://` 或非 HTTPS 非 localhost 打开
- 期望：
  - 控制台出现“非安全上下文”警告
  - 若获取失败，回退到 `getUserMedia` 并提示状态

### CAM-005 CameraUtils 不可用时回退
- 操作：临时阻断 `@mediapipe/camera_utils` 加载
- 期望：
  - 抛出“MediaPipe Camera not loaded”，走 `startFallbackStream()`，状态为“运行中(回退模式)”

### MOD-001 模型正常加载
- 步骤：
  1) 点击启动
  2) 等待模型初始化与测试帧发送
- 期望：
  - `模型: 已加载`（带 `ok` 类）
  - 重试按钮隐藏

### MOD-002 模型加载失败与重试
- 操作：临时阻断 CDN 或改 `locateFile` 指向错误
- 步骤：
  1) 启动 → 加载失败
  2) 点击“重试加载模型”
- 期望：
  - `模型: MediaPipe未加载/模型测试失败/初始化失败` 之一
  - 点击重试后可恢复至“已加载”，状态 `模型重试成功`

### MOD-003 onResults 回调触发
- 步骤：
  1) 模型加载成功
  2) 保持正脸
- 期望：
  - `检测: 检测到人脸`，`EAR` 数值更新，`FPS` 更新

### ALG-001 无人脸时清零
- 操作：偏离镜头或遮挡
- 期望：
  - `EAR: -`，`检测: 未检测到人脸`，`consecClosedFrames` 清零，预警隐藏

### ALG-002 检测到人脸
- 步骤：正脸、光照均匀
- 期望：
  - `检测: 检测到人脸`，`EAR` 连续更新，叠加关键点可见（若开启）

### ALG-003 EAR 连续低于阈值触发预警
- 步骤：
  1) 将 `持续帧数` 调低（如 5）
  2) 闭眼持续约 5 帧（> 0.15s @30FPS）
- 期望：
  - 达到门限后显示“疲劳预警”，UI `alert` 显示为 `block`

### ALG-004 EAR 回升后解除预警
- 操作：睁眼
- 期望：
  - `consecClosedFrames` 归零，预警隐藏

### CFG-001 置信阈值联动
- 步骤：滑动 `置信阈值`（如 0.5→0.8）
- 期望：
  - `lblConfidence` 文本实时更新
  - `faceMesh.setOptions` 中 `minDetectionConfidence/minTrackingConfidence` 同步更新

### CFG-002 EAR 阈值联动
- 步骤：调高/调低 `EAR` 阈值
- 期望：
  - 调高阈值更容易触发预警；调低阈值更难触发

### CFG-003 持续帧数联动
- 步骤：调整持续帧数（如 5、15、30）并重复闭眼测试
- 期望：
  - 预警触发点与设置一致

### CFG-004 叠加关键点开关
- 步骤：切换“叠加关键点”
- 期望：
  - 关闭时不再绘制 landmark；开启时恢复绘制

### UI-001 FPS 更新
- 期望：
  - `FPS` 数字稳定变动，受设备性能和解析度影响

### UI-002 状态/检测/模型标签
- 期望：
  - 状态文案与流程一致：未启动 → 已获取摄像头 → 模型已加载/加载失败 → 运行中/回退模式

### UI-003 预警显隐
- 期望：
  - 满足条件时 `.alert` 显示；否则隐藏

## 7. 边界与异常用例
- 无摄像头设备：下拉仅“自动选择”，启动失败给出明确状态
- 权限拒绝：状态为“被拒绝访问摄像头”，弹窗提示采取措施
- CDN 不可达：模型未加载，显示重试按钮，回退到基础运行状态
- 设备切换后权限变化：切换失败需有错误提示并可恢复
- 超高分辨率/低性能设备：FPS 降低但系统稳定，无内存泄漏

## 8. 通过准则与记录
- 每个用例需记录：环境、步骤、预期/实际结果、截图/视频、控制台日志
- 判定标准：实际结果与期望一致；关键路径 100% 通过；异常用例行为可解释且可恢复

## 9. 出厂回归集（建议）
- 最小回归集：CAM-001/002，MOD-001/002，ALG-003，CFG-002/003，UI-003
- 浏览器交叉回归：Chrome/Edge/Firefox 各 1 套
- 设备回归：至少 2 款不同摄像头/电脑
